
#include <stdint.h>

#include "DDS.h"

// Private constants

    uint8_t DDS_ctrl = 0x00;
    uint32_t PIR;

const uint16_t SIN_Lookup_Table[512]={
    0x0200, 0x0206, 0x020C, 0x0212, 0x0219, 0x021F, 0x0225, 0x022B,
    0x0232, 0x0238, 0x023E, 0x0244, 0x024B, 0x0251, 0x0257, 0x025D,
    0x0263, 0x0269, 0x0270, 0x0276, 0x027C, 0x0282, 0x0288, 0x028E,
    0x0294, 0x029A, 0x02A0, 0x02A6, 0x02AC, 0x02B2, 0x02B8, 0x02BD,
    0x02C3, 0x02C9, 0x02CF, 0x02D5, 0x02DA, 0x02E0, 0x02E5, 0x02EB,
    0x02F1, 0x02F6, 0x02FC, 0x0301, 0x0306, 0x030C, 0x0311, 0x0316,
    0x031C, 0x0321, 0x0326, 0x032B, 0x0330, 0x0335, 0x033A, 0x033F,
    0x0344, 0x0349, 0x034E, 0x0352, 0x0357, 0x035C, 0x0360, 0x0365,
    0x0369, 0x036E, 0x0372, 0x0376, 0x037A, 0x037F, 0x0383, 0x0387,
    0x038B, 0x038F, 0x0393, 0x0397, 0x039A, 0x039E, 0x03A2, 0x03A5,
    0x03A9, 0x03AC, 0x03B0, 0x03B3, 0x03B6, 0x03B9, 0x03BD, 0x03C0,
    0x03C3, 0x03C6, 0x03C8, 0x03CB, 0x03CE, 0x03D1, 0x03D3, 0x03D6,
    0x03D8, 0x03DA, 0x03DD, 0x03DF, 0x03E1, 0x03E3, 0x03E5, 0x03E7,
    0x03E9, 0x03EB, 0x03EC, 0x03EE, 0x03F0, 0x03F1, 0x03F3, 0x03F4,
    0x03F5, 0x03F6, 0x03F7, 0x03F9, 0x03F9, 0x03FA, 0x03FB, 0x03FC,
    0x03FD, 0x03FD, 0x03FE, 0x03FE, 0x03FE, 0x03FF, 0x03FF, 0x03FF,
    0x03FF, 0x03FF, 0x03FF, 0x03FF, 0x03FE, 0x03FE, 0x03FE, 0x03FD,
    0x03FD, 0x03FC, 0x03FB, 0x03FA, 0x03F9, 0x03F9, 0x03F7, 0x03F6,
    0x03F5, 0x03F4, 0x03F3, 0x03F1, 0x03F0, 0x03EE, 0x03EC, 0x03EB,
    0x03E9, 0x03E7, 0x03E5, 0x03E3, 0x03E1, 0x03DF, 0x03DD, 0x03DA,
    0x03D8, 0x03D6, 0x03D3, 0x03D1, 0x03CE, 0x03CB, 0x03C8, 0x03C6,
    0x03C3, 0x03C0, 0x03BD, 0x03B9, 0x03B6, 0x03B3, 0x03B0, 0x03AC,
    0x03A9, 0x03A5, 0x03A2, 0x039E, 0x039A, 0x0397, 0x0393, 0x038F,
    0x038B, 0x0387, 0x0383, 0x037F, 0x037A, 0x0376, 0x0372, 0x036E,
    0x0369, 0x0365, 0x0360, 0x035C, 0x0357, 0x0352, 0x034E, 0x0349,
    0x0344, 0x033F, 0x033A, 0x0335, 0x0330, 0x032B, 0x0326, 0x0321,
    0x031C, 0x0316, 0x0311, 0x030C, 0x0306, 0x0301, 0x02FC, 0x02F6,
    0x02F1, 0x02EB, 0x02E5, 0x02E0, 0x02DA, 0x02D5, 0x02CF, 0x02C9,
    0x02C3, 0x02BD, 0x02B8, 0x02B2, 0x02AC, 0x02A6, 0x02A0, 0x029A,
    0x0294, 0x028E, 0x0288, 0x0282, 0x027C, 0x0276, 0x0270, 0x0269,
    0x0263, 0x025D, 0x0257, 0x0251, 0x024B, 0x0244, 0x023E, 0x0238,
    0x0232, 0x022B, 0x0225, 0x021F, 0x0219, 0x0212, 0x020C, 0x0206,
    0x0200, 0x01F9, 0x01F3, 0x01ED, 0x01E6, 0x01E0, 0x01DA, 0x01D4,
    0x01CD, 0x01C7, 0x01C1, 0x01BB, 0x01B4, 0x01AE, 0x01A8, 0x01A2,
    0x019C, 0x0196, 0x018F, 0x0189, 0x0183, 0x017D, 0x0177, 0x0171,
    0x016B, 0x0165, 0x015F, 0x0159, 0x0153, 0x014D, 0x0147, 0x0142,
    0x013C, 0x0136, 0x0130, 0x012A, 0x0125, 0x011F, 0x011A, 0x0114,
    0x010E, 0x0109, 0x0103, 0x00FE, 0x00F9, 0x00F3, 0x00EE, 0x00E9,
    0x00E3, 0x00DE, 0x00D9, 0x00D4, 0x00CF, 0x00CA, 0x00C5, 0x00C0,
    0x00BB, 0x00B6, 0x00B1, 0x00AD, 0x00A8, 0x00A3, 0x009F, 0x009A,
    0x0096, 0x0091, 0x008D, 0x0089, 0x0085, 0x0080, 0x007C, 0x0078,
    0x0074, 0x0070, 0x006C, 0x0068, 0x0065, 0x0061, 0x005D, 0x005A,
    0x0056, 0x0053, 0x004F, 0x004C, 0x0049, 0x0046, 0x0042, 0x003F,
    0x003C, 0x0039, 0x0037, 0x0034, 0x0031, 0x002E, 0x002C, 0x0029,
    0x0027, 0x0025, 0x0022, 0x0020, 0x001E, 0x001C, 0x001A, 0x0018,
    0x0016, 0x0014, 0x0013, 0x0011, 0x000F, 0x000E, 0x000C, 0x000B,
    0x000A, 0x0009, 0x0008, 0x0006, 0x0006, 0x0005, 0x0004, 0x0003,
    0x0002, 0x0002, 0x0001, 0x0001, 0x0001, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0001, 0x0001, 0x0001, 0x0002,
    0x0002, 0x0003, 0x0004, 0x0005, 0x0006, 0x0006, 0x0008, 0x0009,
    0x000A, 0x000B, 0x000C, 0x000E, 0x000F, 0x0011, 0x0013, 0x0014,
    0x0016, 0x0018, 0x001A, 0x001C, 0x001E, 0x0020, 0x0022, 0x0025,
    0x0027, 0x0029, 0x002C, 0x002E, 0x0031, 0x0034, 0x0037, 0x0039,
    0x003C, 0x003F, 0x0042, 0x0046, 0x0049, 0x004C, 0x004F, 0x0053,
    0x0056, 0x005A, 0x005D, 0x0061, 0x0065, 0x0068, 0x006C, 0x0070,
    0x0074, 0x0078, 0x007C, 0x0080, 0x0085, 0x0089, 0x008D, 0x0091,
    0x0096, 0x009A, 0x009F, 0x00A3, 0x00A8, 0x00AD, 0x00B1, 0x00B6,
    0x00BB, 0x00C0, 0x00C5, 0x00CA, 0x00CF, 0x00D4, 0x00D9, 0x00DE,
    0x00E3, 0x00E9, 0x00EE, 0x00F3, 0x00F9, 0x00FE, 0x0103, 0x0109,
    0x010E, 0x0114, 0x011A, 0x011F, 0x0125, 0x012A, 0x0130, 0x0136,
    0x013C, 0x0142, 0x0147, 0x014D, 0x0153, 0x0159, 0x015F, 0x0165,
    0x016B, 0x0171, 0x0177, 0x017D, 0x0183, 0x0189, 0x018F, 0x0196,
    0x019C, 0x01A2, 0x01A8, 0x01AE, 0x01B4, 0x01BB, 0x01C1, 0x01C7,
    0x01CD, 0x01D4, 0x01DA, 0x01E0, 0x01E6, 0x01ED, 0x01F3, 0x01F9
};



/**
 * @brief Implement a Direct Digital Synthesizer (DDS) for sine wave generation.
 *
 * @param PIR The Phase Increment Register (PIR) is used to set the operating
 *        frequency of the DDS.
 *
 * @return Sine wave samples in 12-bit format.
 *
 * @note
 *
 * - For best performance this routine is called from the ISR at regular
 *   intervals.
 *
*/
uint16_t DDS_service (void){
    return DDS_service_1( );
}


uint16_t DDS_service_1 (void){

    static uint32_t temp_32;
    static uint32_t accumulator_32 = 0;
    uint16_t DDS_temp;

    accumulator_32 += PIR;

    temp_32 = accumulator_32 >> 23;                // The DDS has 512 elements in the sin look-up table

    if (DDS_ctrl == 0x01){
        return  *(SIN_Lookup_Table + temp_32);     // get the sin wave
    }
    else{
        return 0x0000;
    }
}


uint16_t DDS_service_2 (uint32_t phase_shift){

    static uint32_t temp_32;
    static uint32_t accumulator_32 = phase_shift;
    uint16_t DDS_temp;

    accumulator_32 += PIR;

    temp_32 = accumulator_32 >> 23;                // The DDS has 512 elements in the sin look-up table

    if (DDS_ctrl == 0x01){
       return  *(SIN_Lookup_Table + temp_32);     // get the sin wave
    }
    else{
        return 0x0000;
    }
}


/**
 * @brief Turn on the DDS.
 *
 * @param void
 *
 * @return void
 */
 void DDS_on(void){
    DDS_ctrl = 0x01;
 }


 /**
 * @brief Turn off the DDS.
 *
 * @param void
 *
 * @return void
 */
 void DDS_off(void){
    DDS_ctrl = 0x00;
 }


//TODO: Wouldn't it be easier to pass the desired frequency instead of the PIR?
 /**
  * @brief Set the DDS frequency.
  *
  * @param PIR (Phase Increment Register) is a 32 bit value that determines
  *        the output frequency of the the DDS.  The output frequency is
  *        calculated as:
  *
  *                          PIR
  *          f_out = ----------------------
  *                    (2^32)  * T_ISR
  *
  * @return void
  *
 */

 void DDS_set_PIR(uint32_t X){
    PIR = X;
 }
